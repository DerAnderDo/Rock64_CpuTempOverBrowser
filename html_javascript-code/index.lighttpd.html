<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Simple Rock64 CPU Temperature Chart</title>
        <script src="chart.js"></script>
    </head>
    <body>
      
      <div class="chart-container" style="position: relative; height:40vh; width:95vw">
        <canvas id="chart1"></canvas>
        <canvas id="chart2"></canvas>
        <canvas id="chart3"></canvas>
        <script>
            const chart1 = ['chart1', '/data/0_Temperatures.csv'];
            const chart2 = ['chart2', '/data/2_Temperatures.csv'];
            const chart3 = ['chart3', '/data/3_Temperatures.csv'];
            var date = "";

            chartIt(chart1[0], chart1[1]);
            chartIt(chart2[0], chart2[1]);
            chartIt(chart3[0], chart3[1]);
            
            async function chartIt(chart_id, table_no){
              const data_axis = await getData(table_no);
              const data = {
                labels: data_axis.xs,
                datasets: [{
                  label: 'Lowpass filtered',
                  backgroundColor: 'rgb(20, 196, 250)',
                  borderColor: 'rgb(20, 196, 250)',
                  data: data_axis.filtered,
                },
              {
                  label: 'Rock64 CPU Temperature for ' + date,
                  backgroundColor: 'rgb(255, 99, 132)',
                  borderColor: 'rgb(255, 99, 132)',
                  data: data_axis.ys,
              }]
              };
          
              const config = {
                type: 'line',
                data: data,
                options: {
                  scales: {
                    y: {
                      //min: 35,
                      //max: 65,
                    }
                  }
                }
              };

              const myChart = new Chart(
                document.getElementById(chart_id),
                config
              );
            }

            getData(chart1[1]);
            getData(chart2[1]);
            getData(chart3[1]);

            async function getData(table_no){
                const xs = [];
                const ys = [];
                const response = await fetch(table_no);
                console.log("Loading Table: " + table_no);
                const data = await response.text();

                const pretable = data.split('\n');
                date = pretable[0];
                const table = pretable.slice(1);
                table.forEach(row => {
                    const cols = row.split(',');
                    const time = cols[0];
                    xs.push(time);
                    const temp = cols[1];
                    ys.push(parseFloat(temp));
                });

                //Lowpass Filter
                var old_in = 0;
                var old_out = ys[0]; //"pre-charge capacitor", so graph doesnt start from 0
                var input = 0;
                var output = 0;
                run_filter();
                const filtered = [];

                for (i = 1; i < ys.length-2; i++){
                  input = ys[i];
                  old_in = ys[i-1];
                  run_filter();
                  old_out = output;
                  filtered.push(output);
                  };
                  
                function run_filter(){
                  output = old_out*0.8 + input*0.1 + old_in*0.1;
                }

                return {xs, ys, filtered};
                }
        </script>
      </div>
    </body>
</html>
